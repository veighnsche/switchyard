# SPEC → Code → Test Traceability (Seed)

This file maps SPEC features and schema to code modules and tests. Initially a seed; to be refined as implementation proceeds.

| SPEC Artifact | Description | Code Modules (initial guess) | Tests/Evidence |
|---|---|---|---|
| `features/api_toctou.feature` | TOCTOU-safe sequences | `fs_ops.rs`, `api.rs` | unit + integration + BDD |
| `features/atomic_swap.feature` | Atomic file swaps | `fs_ops.rs` | unit + BDD |
| `features/conservatism_ci.feature` | Fail-closed CI policy | `preflight.rs`, `api.rs` | policy tests + BDD |
| `features/determinism_attestation.feature` | Deterministic behaviors | `api.rs`, `preflight.rs` | golden logs + BDD |
| `features/locking_rescue.feature` | Locking and rescue behavior | `fs_ops.rs` | unit + BDD |
| `features/observability.feature` | Audit/observability | `api.rs` | schema validation + BDD |
| `features/operational_bounds.feature` | Operational limits | `preflight.rs` | unit + BDD |
| `features/safety_preconditions.feature` | Preconditions & SafePath | `preflight.rs`, `fs_ops.rs` | negative BDDs + unit |
| `audit_event.schema.json` | Audit schema | `api.rs` | CI schema validation |

## Requirement Group → Module/Test Mapping (planning)

This section summarizes how requirement groups from `SPEC/requirements.yaml` map to modules and evidence. The authoritative coverage report is generated by `SPEC/tools/traceability.py` into `SPEC/traceability.md`.

- Atomicity (REQ-A1..A3)
  - Modules: `fs_ops.rs` (rename flow), `api.rs` (orchestration)
  - Evidence: `atomic_swap.feature::{Enable and rollback, Automatic rollback on mid-plan failure}`; property tests `AtomicReplace`, `IdempotentRollback`
  - Acceptance: No broken/missing path visible; reverse-order auto-rollback on failure; idempotent rollback

- Rollback (REQ-R1..R5)
  - Modules: `api.rs` (plan/apply/rollback), `fs_ops.rs` (backup/restore paths)
  - Evidence: `atomic_swap.feature`; facts include partial restoration guidance on rollback error
  - Acceptance: Second rollback is a no-op; facts record partial restoration state when applicable

- Safety Preconditions (REQ-S1..S5)
  - Modules: `preflight.rs` (policy gating), `fs_ops.rs` (SafePath/TOCTOU enforcement)
  - Evidence: `safety_preconditions.feature` negative scenarios; unit tests for SafePath normalization
  - Acceptance: Fail-closed on policy or FS capability gaps unless explicitly overridden

- Observability & Audit (REQ-O1..O7, REQ-VERS1)
  - Modules: `api.rs` (fact emission), shared logging/adapters
  - Evidence: `observability.feature`; schema validation against `audit_event.schema.json`; golden facts
  - Acceptance: 100% facts validate; masking and provenance fields present; schema_version=v1

- Locking (REQ-L1..L4)
  - Modules: `api.rs` (apply engine), `LockManager` adapter
  - Evidence: `locking_rescue.feature` bounded wait and WARN in dev/test
  - Acceptance: Single mutator; `lock_wait_ms` recorded; `E_LOCKING` on timeout

- Determinism (REQ-D1..D2)
  - Modules: `api.rs` (UUIDv5 ids), redaction utilities
  - Evidence: `determinism_attestation.feature` UUIDv5; `observability.feature` dry-run byte identity
  - Acceptance: Byte-identical dry-run vs real-run after redaction; stable ordering

- Conservatism & Modes (REQ-C1..C2)
  - Modules: `api.rs` (default ApplyMode), `preflight.rs` (fail-closed policy)
  - Evidence: `conservatism_ci.feature`
  - Acceptance: Dry-run by default; fail-closed without override

- Health Verification (REQ-H1..H3)
  - Modules: `SmokeTestRunner` adapter
  - Evidence: `atomic_swap.feature :: Smoke test failure triggers rollback`
  - Acceptance: Smoke suite runs post-apply; failure triggers auto-rollback unless disabled

- Filesystems & Degraded Mode (REQ-F1..F3)
  - Modules: `fs_ops.rs` (EXDEV fallback), `api.rs` (policy/degraded facts)
  - Evidence: `atomic_swap.feature :: Cross-filesystem EXDEV fallback`; acceptance tests per FS
  - Acceptance: Safe copy+sync+rename on EXDEV; `degraded=true` fact when allowed; fail when disallowed

## Acceptance Criteria Conventions

- BDD scenarios under `SPEC/features/*.feature` must pass without SKIP; mapped to requirement IDs via tags (e.g., `@REQ-A1`).
- Facts produced in tests validate against `SPEC/audit_event.schema.json` and match golden fixtures byte-for-byte.
- Property tests affirm invariants `AtomicReplace` and `IdempotentRollback`.
- `SPEC/tools/traceability.py` reports 100% coverage of MUST/MUST_NOT; CI fails otherwise.

## CI Evidence Hooks (planning)

- Run `python3 SPEC/tools/traceability.py` → generate/verify `SPEC/traceability.md`.
- Validate Gherkin steps against `SPEC/features/steps-contract.yaml`.
- Schema-validate JSON facts against `SPEC/audit_event.schema.json`.
- Golden diff check for plan/preflight/apply/rollback fixtures; zero-SKIP gate.
